/* storyturtle v0.0.5 | http://github.com/kevinbeaty/storyturtle | License: MIT */(function(a){var b={},c=function(a){var c=/(\w+)\.?.*$/.exec(a)[1];return b[c]};b.config=function(a){var b;return b={images:{},board:{width:300,height:300},editor:{rows:15,cols:30},controls:{width:300,height:25},animationDuration:1e3},a.config=b,a}({}),b.runloop=function(b){function g(){c||(c=!0,j())}function h(){c=!1}function i(a){d.push(a),c||g()}function j(){c&&(f(j),k())}function k(){var a,b=0,c=d.length,e=!1,f=+(new Date);for(;b<c;++b){try{e=!d[b](f)}catch(g){e=!0}e&&(d.splice(b,1),c--)}c<=0&&h()}var c=!1,d=[],e=0,f=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.msRequestAnimationFrame||a.oRequestAnimationFrame||function(b,c){var d=+(new Date),f=Math.max(0,16-(d-e)),g=a.setTimeout(function(){b(d+f)},f);return e=d+f,g};return b.run=g,b.stop=h,b.addResponder=i,b}({}),b.featuretype=function(a){function b(a,b){this.name=a,this.canvas=b}a.FeatureType=b;var c=b.prototype;return a}({}),b.feature=function(a){function b(a,b){this.name=a,this.type=b,this.alive=!0}a.Feature=b;var c=b.prototype;return c.position=function(a,b){return this.x=a,this.y=b,this},c.size=function(a,b){return this.width=a,this.height=b,this},a}({}),b.context=function(a){function j(a){h=a,i=h.getContext("2d"),e.addResponder(function(){return i?(i.clearRect(0,0,h.width,h.height),!0):!1})}function k(a,c){var d=new b(a,c);return f[a]=d,d}function l(a){return g[a]}function m(a,b){var c=f[b],h=new d(a,c);return g[a]=h,e.addResponder(function(){var a=h.type.canvas;return i.drawImage(a,0,0,a.width,a.height,h.x,h.y,h.width,h.height),h.alive}),h}function n(a){var b=g[a];b&&(b.alive=!1,delete g[a])}var b=c("./featuretype").FeatureType,d=c("./feature").Feature,e=c("./runloop"),f={},g={},h,i;return a.setCanvas=j,a.addFeatureType=k,a.feature=l,a.addFeature=m,a.removeFeature=n,a}({}),b.imageloader=function(a){function b(a,b){var c={},d,e,f=0;for(d in a)f++;countdown=function(){--f<=0&&b(c)};for(d in a)e=new Image,c[d]=e,e.onload=countdown,e.src=a[d]}return a.loadImages=b,a}({}),b.actions=function(a){var b,d,e;return d=c("./context"),e=c("./runloop"),b=function(){function a(a,b){this.config=a,this.speaker=b,this.moveQueue=[]}return a.prototype.create=function(a,b,c,e){var f,g,h,i,j,k,l;return console.log("create "+a+" "+b+" "+c+" "+e),d.removeFeature(a),g=d.addFeature(a,b),g.position(c,e),f=this.config.board.width/10,(g!=null?(l=g.type)!=null?l.canvas:void 0:void 0)?(i=g.type.canvas,k=i.width||f,h=i.height||f,j=f/h,k*=j,h*=j):(h=f,k=f),g.size(k,h),!0},a.prototype.die=function(a){return console.log("die "+a),d.removeFeature(a),!0},a.prototype.move=function(a,b,c){var e;return console.log("move "+a+" "+b+" "+c),e=d.feature(a),e&&this.moveQueue.push({feature:e,x1:e.x,x2:b,y1:e.y,y2:c}),!0},a.prototype.go=function(){var a;return console.log("go"),a=this.moveQueue,this.moveQueue=[],a.length?this.animate(a):!0},a.prototype.animate=function(a){var b,c,d;return console.log("begin animate "+a),b=_r.deferred(),d=+(new Date),c=this.config.animationDuration||1e3,e.addResponder(function(e){var f,g,h,i,j,k;g=(e-d)/c;if(g<1){for(h=0,j=a.length;h<j;h++)f=a[h],f.feature.position(f.x1+(f.x2-f.x1)*g,f.y1+(f.y2-f.y1)*g);return!0}for(i=0,k=a.length;i<k;i++)f=a[i],f.feature.position(f.x2,f.y2);return console.log("done animate "+a),b.resolve(!0),!1}),b},a.prototype.pause=function(a){return console.log("pause "+a),_r(!0).delay(a*10)},a.prototype.say=function(a){return console.log("speak "+a),this.speaker.text(a),!0},a.prototype.says=function(a,b){return console.log(a+" says "+b),this.speaker.text(""+a+' says, "'+b+'"'),!0},a}(),a.Actions=b,a}({}),b.parser=function(a){function d(a,d){b=d;var e=a.split("\n");e.push("\n");var f;return e.forEach(function(a){f?f=f.then(_r(a).map(c)):f=_r(a).map(c)}),f}var b,c=_r().map([_r().map(/(\w+)\s+is\s+an?\s+(\w+)\s+at\s+(\d+)\s+(\d+)/).filter().map(function(a){return b.create(a[1],a[2],parseInt(a[3],10),parseInt(a[4],10))}),_r().map(/(\w+)\s+dies/).filter().map(function(a){return b.die(a[1])}),_r().map(/(\w+)\s+moves\s+to\s+(\d+)\s+(\d+)/).filter().map(function(a){return b.move(a[1],parseInt(a[2],10),parseInt(a[3],10))}),_r().map(/pause\s+(\d+)/).filter().map(function(a){return b.pause(parseInt(a[1],10))}),_r().map(/say\s+(.+)/).filter().map(function(a){return b.say(a[1])}),_r().map(/(\w+)\s+says\s+(.*)/).filter().map(function(a){return b.says(a[1],a[2])}),_r().filter(/^\s*$/).map(function(){return b.go()})]);return a.parse=d,a.parse=d,a.grammer=c,a}({}),b.init2=function(a){function f(a,c){var d=document.createElement("canvas"),f=d.getContext("2d");d.width=c.board.width,d.height=c.board.height,a.appendChild(d),b(c.images,function(a){g(a),e.setCanvas(d)})}function g(a){var b,c,d,f;for(b in a)c=a[b],d=document.createElement("canvas"),d.width=c.width,d.height=c.height,f=d.getContext("2d"),f.drawImage(c,0,0),e.addFeatureType(b,d)}var b=c("./imageloader").loadImages,d=c("./runloop"),e=c("./context");return a.init=f,a}({}),b.init=function(a){var b,d,e,f,g,h;return e=c("./config").config,g=c("./parser").parse,d=c("./actions").Actions,b=jQuery,b.fn.storyturtle=function(a){return e=b.extend(!0,e,a),this.each(function(){return f(b(this))})},f=function(a){var f,i,j,k,l,m,n,o;return a.hide().width(Math.max(e.board.width,e.controls.width)).height(e.board.height+e.controls.height),j=b("<textarea>",{rows:e.editor.rows,cols:e.editor.cols}).hide().val(a.text()).appendTo(a.text("")),l=b("<div>").width(e.controls.width).height(e.controls.height).appendTo(a),k=b("<a>",{href:"#"}).text("Play!").css({"float":"left"}),i=b("<a>",{href:"#"}).text("Edit").css({"float":"right"}),f=b("<div>").width(e.controls.width).height(e.controls.height).append(k,i).appendTo(a),(o=c("./init2"))!=null&&o.init(b(a).get(0),e),m=h(a),(n=m.get())&&j.val(n),k.click(function(){var a,b;return j.hide(),i.show(),f.hide(),b=j.val(),a=new d(e,l),g(b,a).then(function(){return l.text(""),f.show()}),m.set(b),!1}),i.click(function(){return i.hide(),j.show(),!1}),a.show()},h=function(a){return{set:function(b){var c;c=a.data("story");if(c)return typeof localStorage!="undefined"&&localStorage!==null?localStorage.setItem("storyturtle_"+c,b):void 0},get:function(){var b;return b=a.data("story"),b&&(typeof localStorage!="undefined"&&localStorage!==null?localStorage.getItem("storyturtle_"+b):void 0)}}},a}({})})(this);