/* storyturtle v0.0.5 | http://github.com/kevinbeaty/storyturtle | License: MIT */(function(a){var b={},c=function(a){var c=/(\w+)\.?.*$/.exec(a)[1];return b[c]};b.runloop=function(b){function f(a){return g().subscribe(a)}function g(){return c||(c=_r.deferred(),i()),c}function h(){c.complete(),c=null}function i(){c&&(e(i),c.next(+(new Date)))}var c=null,d=0,e=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.msRequestAnimationFrame||a.oRequestAnimationFrame||function(b,c){var e=+(new Date),f=Math.max(0,16-(e-d)),g=a.setTimeout(function(){b(e+f)},f);return d=e+f,g};return b.subscribe=f,b.run=g,b.stop=h,b}({}),b.featuretype=function(a){function b(a,b){this.name=a,this.canvas=b}a.FeatureType=b;var c=b.prototype;return a}({}),b.feature=function(a){function b(a,b){this.name=a,this.type=b,this.alive=!0}a.Feature=b;var c=b.prototype;return c.position=function(a,b){return this.x=a,this.y=b,this},c.size=function(a,b){return this.width=a,this.height=b,this},a}({}),b.context=function(a){function j(a){h=a,i=h.getContext("2d");var b=e.subscribe(function(){i||b.dispose(),i.clearRect(0,0,h.width,h.height)})}function k(b){a.speak=b}function l(a,c){var d=new b(a,c);return f[a]=d,d}function m(a){return g[a]}function n(a,b){var c=f[b],h=new d(a,c),j=e.subscribe(function(){var a=h.type.canvas;i.drawImage(a,0,0,a.width,a.height,h.x,h.y,h.width,h.height),h.alive||j.dispose()});return g[a]=h,h}function o(a){var b=g[a];b&&(b.alive=!1,delete g[a])}var b=c("./featuretype").FeatureType,d=c("./feature").Feature,e=c("./runloop"),f={},g={},h,i;return a.setCanvas=j,a.setSpeaker=k,a.addFeatureType=l,a.feature=m,a.addFeature=n,a.removeFeature=o,a}({}),b.imageloader=function(a){var b=_r().seq().map(function(a){return{name:a[0],src:a[1],loadImage:function(){var a=this,b=_r.deferred();return a.image=document.createElement("img"),a.image.onload=function(){b.resolve(a)},a.image.src=a.src,b.promise}}}).call("loadImage").pick("name","image");return a.loadImages=function(a){return b.attach(a)},a}({}),b.parser=function(a){function l(a,b){e=b||e,f=[];var c=a.split("\n");c.push("\n");var d;return _r(c).each(function(a){d?d=d.then(_r(a).map(k)):d=_r(a).map(k)}),d}var b=c("./context"),d=c("./runloop"),e={},f=[],g=function(a,c,d,f){b.removeFeature(a);var g=b.addFeature(a,c),h=g.type.canvas,i=e.imageDimension||30,j=h.width||i,k=h.height||i,l=i/k;j*=l,k*=l,g.position(d,f),g.size(j,k)},h=function(a,c,d){var e=b.feature(a);e&&f.push({feature:e,x1:e.x,x2:c,y1:e.y,y2:d})},i=function(){var a=f;f=[];if(a.length)return j(a)},j=function(a){var b=_r.deferred(),c=+(new Date),f=e.animationDuration||1e3,g=d.subscribe(function(d){percent=(d-c)/f,percent<1?_r(a).each(function(a){a.feature.position(a.x1+(a.x2-a.x1)*percent,a.y1+(a.y2-a.y1)*percent)}):(_r(a).each(function(a){a.feature.position(a.x2,a.y2)}),b.resolve(!0),g.dispose())});return b},k=_r().map([_r().map(/(\w+)\s+is\s+an?\s+(\w+)\s+at\s+(\d+)\s+(\d+)/).filter().map(function(a){return g(a[1],a[2],parseInt(a[3],10),parseInt(a[4],10))}),_r().map(/(\w+)\s+dies/).filter().map(function(a){return b.removeFeature(a[1])}),_r().map(/(\w+)\s+moves\s+to\s+(\d+)\s+(\d+)/).filter().map(function(a){return h(a[1],parseInt(a[2],10),parseInt(a[3],10))}),_r().map(/pause\s+(\d+)/).filter().map(function(a){return _r(!0).delay(parseInt(a[1],10)*10)}),_r().map(/say\s+(.+)/).filter().map(function(a){return b.speak(a[1])}),_r().map(/(\w+)\s+says\s+(.*)/).filter().map(function(a){return b.speak(a[1]+' says, "'+a[2]+'"')}),_r().filter(/^\s*$/).map(i)]);return a.parse=l,a.grammer=k,a}({}),b.init=function(a){function l(a){_r(a).defaults(b).first().then(function(a){return b=a,f(b.images).then(null,null,n)}).then(function(){m()})}function m(){var a=g("story"),c=g("canvas"),f=g("speaker"),i=g("controls"),l=g("play"),m=g("edit"),n=o(a),p=n.get();d.setCanvas(c),d.setSpeaker(function(a){var b=f.firstChild;for(;b!==null;b=f.firstChild)f.removeChild(b);f.appendChild(document.createTextNode(a))}),p&&(a.value=p),h(l,"click",function(){return k(c),j(a),k(m),j(i),gameText=a.value,e(gameText,b).then(function(){f.innerHTML="",k(i)}),n.set(gameText),!1}),h(m,"click",function(){return j(c),j(m),k(a),!1})}function n(a){var b=a.image,c=a.name,e=document.createElement("canvas");e.width=b.width,e.height=b.height,context2d=e.getContext("2d"),context2d.drawImage(b,0,0),d.addFeatureType(c,e)}function o(a){return{set:function(b){var c=a.getAttribute("data-story");c&&localStorage&&localStorage.setItem("storyturtle_"+c,b)},get:function(){var b=a.getAttribute("data-story");return b&&localStorage&&localStorage.getItem("storyturtle_"+b)}}}var b={images:{},imageDimension:30,animationDuration:1e3},d=c("./context"),e=c("./parser").parse,f=c("./imageloader").loadImages,g=function(a){return document.getElementById("storyturtle-"+a)},h=function(a,b,c){a.addEventListener(b,c)},i=function(a,b){a.style.display=b},j=function(a){i(a,"none")},k=function(a,b){i(a,b||"block")};return a.init=l,a}({}),a.storyturtle=c("./init").init})(this);